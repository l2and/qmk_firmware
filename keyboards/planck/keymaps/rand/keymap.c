/* Copyright 2015-2017 Jack Humbert
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

#include QMK_KEYBOARD_H
#include "rand.h"
#include "muse.h"


const uint16_t PROGMEM keymaps[][MATRIX_ROWS][MATRIX_COLS] = {

    /* _QWERTY (Base)
    *

* ┌────┬────┬────┬────┬────┬────┬────┬────┬────┬────┬────┬────┐
* │Tab │ Q  │ W  │ E  │ R  │ T  │ Y  │ U  │ I  │ O  │ P  │BkSp│
* ├────┼────┼────┼────┼────┼────┼────┼────┼────┼────┼────┼────┤
* │Esc │ A  │ S  │ D  │ F  │ G  │ H  │ J  │ K  │ L  │ ;  │ '  │
* ├────┼────┼────┼────┼────┼────┼────┼────┼────┼────┼────┼────┤
* │Shft│ Z  │ X  │ C  │ V  │ B  │ N  │ M  │ ,  │ .  │ /  │Entr│
* ├────┼────┼────┼────┼────┼────┴────┼────┼────┼────┼────┼────┤
* │Cp/P│CTL │ALT │GUI │LOWR│  Space  │RISE│Left│Down│ Up │Rght│
* └────┴────┴────┴────┴────┴─────────┴────┴────┴────┴────┴────┘
    */

[_QWERTY] = LAYOUT_planck_grid_wrapper(
  //----------------------------------------------------------------------------------------------------------.
     _____________________QWERTY_L1______________________, _____________________QWERTY_R1______________________,
  //|--------+--------+--------+--------+-------+-------+---------+--------+--------+--------+--------+-------|
     _____________________QWERTY_L2______________________, _____________________QWERTY_R2______________________,
  //|--------+--------+--------+--------+-------+-------+---------+--------+--------+--------+--------+-------|
     _____________________QWERTY_L3______________________, _____________________QWERTY_R3______________________,
  //|--------+--------+--------+--------+-------+-------+---------+--------+--------+--------+--------+-------|
                                 ______________________MOD_4_________________________
  //|--------+--------+--------+--------+-------+-------+---------+--------+--------+--------+--------+-------|
),

    /* _GAMING 
    *
* ┌────┬────┬────┬────┬────┬────┬────┬────┬────┬────┬────┬────┐
* │Tab │ Q  │ W  │ E  │ R  │ T  │ Y  │ U  │ I  │ O  │ P  │BkSp│
* ├────┼────┼────┼────┼────┼────┼────┼────┼────┼────┼────┼────┤
* │CTL │ A  │ S  │ D  │ F  │ G  │ H  │ J  │ K  │ L  │ ;  │ '  │
* ├────┼────┼────┼────┼────┼────┼────┼────┼────┼────┼────┼────┤
* │Shft│ Z  │ X  │ C  │ V  │ B  │ N  │ M  │ ,  │ .  │ /  │Entr│
* ├────┼────┼────┼────┼────┼────┴────┼────┼────┼────┼────┼────┤
* │Cp/P│CTL │ALT │GUI │LOWR│  Space  │RISE│Left│Down│ Up │Rght│
* └────┴────┴────┴────┴────┴─────────┴────┴────┴────┴────┴────┘
    */
[_GAMING] = LAYOUT_planck_grid_wrapper(
  //----------------------------------------------------------------------------------------------------------.
     _____________________GAMING_L1_____________________, _____________________GAMING_R1_____________________,
  //|--------+--------+--------+--------+-------+-------+---------+--------+--------+--------+--------+-------|
     _____________________GAMING_L2_____________________, _____________________GAMING_R2_____________________,
  //|--------+--------+--------+--------+-------+-------+---------+--------+--------+--------+--------+-------|
     _____________________GAMING_L3_____________________, _____________________GAMING_R3_____________________,
  //|--------+--------+--------+--------+-------+-------+---------+--------+--------+--------+--------+-------|
                                 ______________________MOD_4_________________________
  //|--------+--------+--------+--------+-------+-------+---------+--------+--------+--------+--------+-------|
),


    /* _DVORAK
    *
* ┌────┬────┬────┬────┬────┬────┬────┬────┬────┬────┬────┬────┐
* │Tab │ '  │ ,  │ .  │ P  │ Y  │ F  │ G  │ C  │ R  │ L  │BkSp|
* ├────┼────┼────┼────┼────┼────┼────┼────┼────┼────┼────┼────┤
* │Esc │ A  │ O  │ E  │ U  │ I  │ D  │ H  │ T  │ N  │ S  │ -  │
* ├────┼────┼────┼────┼────┼────┼────┼────┼────┼────┼────┼────┤
* │Shft│ ;  | Q  │ J  │ K  │ X  │ B  │ M  │ W  │ V  │ Z  │Entr│
* ├────┼────┼────┼────┼────┼────┴────┼────┼────┼────┼────┼────┤
* │Cp/P│CTL │ALT │GUI │LOWR│  Space  │RISE│Left│Down│ Up │Rght│
* └────┴────┴────┴────┴────┴─────────┴────┴────┴────┴────┴────┘
    */
[_DVORAK] = LAYOUT_planck_grid_wrapper(
  //----------------------------------------------------------------------------------------------------------.
     _____________________DVORAK_L1______________________, _____________________DVORAK_R1______________________,
  //|--------+--------+--------+--------+-------+-------+---------+--------+--------+--------+--------+-------|
     _____________________DVORAK_L2______________________, _____________________DVORAK_R2______________________,
  //|--------+--------+--------+--------+-------+-------+---------+--------+--------+--------+--------+-------|
     _____________________DVORAK_L3______________________, _____________________DVORAK_R3______________________,
  //|--------+--------+--------+--------+-------+-------+---------+--------+--------+--------+--------+-------|
                                 ______________________MOD_4_________________________
  //|--------+--------+--------+--------+-------+-------+---------+--------+--------+--------+--------+-------|
),

    /* _LOWER (Symbols / Punctuation / media)
    *
* ┌────┬────┬────┬────┬────┬────┬────┬────┬────┬────┬────┬────┐
* │ ~  │ !  │ @  │ #  │ $  │ %  │ ^  │ &  │ *  │ (  │ )  │BkSp│
* ├────┼────┼────┼────┼────┼────┼────┼────┼────┼────┼────┼────┤
* │Esc │    │    │    │    │    │    │ _  │ +  │ {  │ }  │ |  │
* ├────┼────┼────┼────┼────┼────┼────┼────┼────┼────┼────┼────┤
* │Shft│    │    │    │    │    │    │Left│Down│ Up │Rght│Entr│
* ├────┼────┼────┼────┼────┼────┴────┼────┼────┼────┼────┼────┤
* │Cp/P│CTL │ALT │GUI │LOWR│  Space  │RISE│Left│Down│ Up │Rght│
* └────┴────┴────┴────┴────┴─────────┴────┴────┴────┴────┴────┘
    */
[_LOWER] = LAYOUT_planck_grid_wrapper(
  //----------------------------------------------------------------------------------------------------------.
     _____________________SYM_LEFT_______________________, _____________________SYM_RIGHT______________________,
  //|--------+--------+--------+--------+-------+-------+---------+--------+--------+--------+--------+-------|
     _____________________LOWER_L2_______________________, _____________________LOWER_R2_______________________,
  //|--------+--------+--------+--------+-------+-------+---------+--------+--------+--------+--------+-------|
     _____________________LOWER_L3_______________________, _____________________LOWER_R3_______________________,
  //|--------+--------+--------+--------+-------+-------+---------+--------+--------+--------+--------+-------|
                                 ______________________MOD_4_________________________
  //|--------+--------+--------+--------+-------+-------+---------+--------+--------+--------+--------+-------|
),

    /* _RAISE (Function / Numbers)
    *
* ┌────┬────┬────┬────┬────┬────┬────┬────┬────┬────┬────┬────┐
* │ `  │ 1  │ 2  │ 3  │ 4  │ 5  │ 6  │ 7  │ 8  │ 9  │ 0  │BkSp│
* ├────┼────┼────┼────┼────┼────┼────┼────┼────┼────┼────┼────┤
* │Esc │ F1 │ F2 │ F3 │ F4 │ F5 │ F6 │ -  │ =  │ [  │ ]  │ \  │
* ├────┼────┼────┼────┼────┼────┼────┼────┼────┼────┼────┼────┤
* │Shft│ F7 │ F8 │ F9 │F10 │F11 |F12 │Left│Down│ Up │Rght│Entr│
* ├────┼────┼────┼────┼────┼────┴────┼────┼────┼────┼────┼────┤
* │ADJ │CTL │ALT │GUI │LOWR│  Space  │RISE│Left│Down│ Up │Rght│
* └────┴────┴────┴────┴────┴─────────┴────┴────┴────┴────┴────┘
    */
[_RAISE] = LAYOUT_planck_grid_wrapper(
  //----------------------------------------------------------------------------------------------------------.
     _____________________NUM_LEFT_______________________, _____________________NUM_RIGHT______________________,
  //|--------+--------+--------+--------+-------+-------+---------+--------+--------+--------+--------+-------|
     _____________________RAISE_L2_______________________, _____________________RAISE_R2_______________________,
  //|--------+--------+--------+--------+-------+-------+---------+--------+--------+--------+--------+-------|
     _____________________RAISE_L3_______________________, _____________________RAISE_R3_______________________,
  //|--------+--------+--------+--------+-------+-------+---------+--------+--------+--------+--------+-------|
                                 ______________________MOD_4_________________________
  //|--------+--------+--------+--------+-------+-------+---------+--------+--------+--------+--------+-------|
),

    /* _ADJUST (DFU Reset / RGB Toggle) {In progress}
    *
* ┌────┬────┬────┬────┬────┬────┬────┬────┬────┬────┬────┬────┐
* │MAKE│RST │    │    │    │    │RGB │    │    │GAME│DVOR│QWER|
* ├────┼────┼────┼────┼────┼────┼────┼────┼────┼────┼────┼────┤
* │VRSN│MALL│RSPI│RSAI|RHUI│RVAI│    │    │    │    │    │    │
* ├────┼────┼────┼────┼────┼────┼────┼────┼────┼────┼────┼────┤
* │FLSH│    │RSPD│RSAD│RHUD│RVAD|RMOD│    │    │    │    │    │
* ├────┼────┼────┼────┼────┼────┴────┼────┼────┼────┼────┼────┤
* │    │    │    │    │    │    │    │    │    │    │    │    │
* └────┴────┴────┴────┴────┴─────────┴────┴────┴────┴────┴────┘
    */
[_ADJUST] = LAYOUT_planck_grid_wrapper(
  //----------------------------------------------------------------------------------------------------------.
     _____________________ADJUST_L1______________________, _____________________ADJUST_R1______________________,
  //|--------+--------+--------+--------+-------+-------+---------+--------+--------+--------+--------+-------|
     _____________________ADJUST_L2______________________, _____________________ADJUST_R2______________________,
  //|--------+--------+--------+--------+-------+-------+---------+--------+--------+--------+--------+-------|
     _____________________ADJUST_L3______________________, _____________________ADJUST_R3______________________,
  //|--------+--------+--------+--------+-------+-------+---------+--------+--------+--------+--------+-------|
     __________________________________, __________________________________, __________________________________
  //|--------+--------+--------+--------+-------+-------+---------+--------+--------+--------+--------+-------|
)

};

layer_state_t layer_state_set_user(layer_state_t state) {
  return update_tri_layer_state(state, _LOWER, _RAISE, _ADJUST);
}

bool muse_mode = false;
uint8_t last_muse_note = 0;
uint16_t muse_counter = 0;
uint8_t muse_offset = 70;
uint16_t muse_tempo = 50;

void encoder_update(bool clockwise) {
  if (muse_mode) {
    if (IS_LAYER_ON(_RAISE)) {
      if (clockwise) {
        muse_offset++;
      } else {
        muse_offset--;
      }
    } else {
      if (clockwise) {
        muse_tempo+=1;
      } else {
        muse_tempo-=1;
      }
    }
  } else {
    if (clockwise) {
      #ifdef MOUSEKEY_ENABLE
        tap_code(KC_MS_WH_DOWN);
      #else
        tap_code(KC_PGDN);
      #endif
    } else {
      #ifdef MOUSEKEY_ENABLE
        tap_code(KC_MS_WH_UP);
      #else
        tap_code(KC_PGUP);
      #endif
    }
  }
}

void matrix_scan_user(void) {
#ifdef AUDIO_ENABLE
    if (muse_mode) {
        if (muse_counter == 0) {
            uint8_t muse_note = muse_offset + SCALE[muse_clock_pulse()];
            if (muse_note != last_muse_note) {
                stop_note(compute_freq_for_midi_note(last_muse_note));
                play_note(compute_freq_for_midi_note(muse_note), 0xF);
                last_muse_note = muse_note;
            }
        }
        muse_counter = (muse_counter + 1) % muse_tempo;
    } else {
        if (muse_counter) {
            stop_all_notes();
            muse_counter = 0;
        }
    }
#endif
}

bool music_mask_user(uint16_t keycode) {
  switch (keycode) {
    case _RAISE:
    case _LOWER:
      return false;
    default:
      return true;
  }
}
